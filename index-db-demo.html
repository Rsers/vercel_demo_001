<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vercel æ•°æ®åº“å®è·µæ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 2rem;
        }

        .section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 15px;
            background: #f8fafc;
        }

        .section h2 {
            color: #374151;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0.25rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .users-table th,
        .users-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .users-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .users-table tr:hover {
            background: #f8fafc;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4f46e5;
        }

        .stat-label {
            color: #6b7280;
            margin-top: 0.5rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .search-box {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .search-box:focus {
            outline: none;
            border-color: #4f46e5;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .users-table {
                font-size: 0.875rem;
            }

            .users-table th,
            .users-table td {
                padding: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—„ï¸ Vercel æ•°æ®åº“å®è·µæ¼”ç¤º</h1>
            <p>ä½¿ç”¨ Vercel PostgreSQL è¿›è¡Œ CRUD æ“ä½œå®è·µ</p>
        </div>

        <div class="content">
            <!-- æ•°æ®åº“åˆå§‹åŒ– -->
            <div class="section">
                <h2>ğŸ“Š æ•°æ®åº“åˆå§‹åŒ–</h2>
                <p>é¦–å…ˆéœ€è¦åˆå§‹åŒ–æ•°æ®åº“è¡¨ï¼Œè¿™åªéœ€è¦æ‰§è¡Œä¸€æ¬¡ã€‚</p>
                <button class="btn btn-primary" onclick="initDatabase()">åˆå§‹åŒ–æ•°æ®åº“</button>
                <div id="init-result"></div>
            </div>

            <!-- æ·»åŠ ç”¨æˆ· -->
            <div class="section">
                <h2>â• æ·»åŠ ç”¨æˆ·</h2>
                <form id="user-form">
                    <div class="form-group">
                        <label for="name">å§“å *</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group">
                        <label for="email">é‚®ç®± *</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="age">å¹´é¾„</label>
                        <input type="number" id="age" min="1" max="120">
                    </div>
                    <div class="form-group">
                        <label for="city">åŸå¸‚</label>
                        <input type="text" id="city">
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ ç”¨æˆ·</button>
                </form>
                <div id="add-result"></div>
            </div>

            <!-- æœç´¢ç”¨æˆ· -->
            <div class="section">
                <h2>ğŸ” æœç´¢ç”¨æˆ·</h2>
                <input type="text" class="search-box" id="search-input" placeholder="è¾“å…¥å§“åã€é‚®ç®±æˆ–åŸå¸‚è¿›è¡Œæœç´¢...">
                <button class="btn btn-secondary" onclick="searchUsers()">æœç´¢</button>
                <button class="btn btn-secondary" onclick="loadAllUsers()">æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·</button>
                <div id="search-result"></div>
            </div>

            <!-- ç”¨æˆ·åˆ—è¡¨ -->
            <div class="section">
                <h2>ğŸ“‹ ç”¨æˆ·åˆ—è¡¨</h2>
                <button class="btn btn-secondary" onclick="loadAllUsers()">åˆ·æ–°åˆ—è¡¨</button>
                <div id="users-list">
                    <div class="loading">ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"åŠ è½½ç”¨æˆ·æ•°æ®</div>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="section">
                <h2>ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯</h2>
                <button class="btn btn-secondary" onclick="loadStats()">åˆ·æ–°ç»Ÿè®¡</button>
                <div id="stats-content">
                    <div class="loading">ç‚¹å‡»"åˆ·æ–°ç»Ÿè®¡"åŠ è½½ç»Ÿè®¡æ•°æ®</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ç›‘æ§è„šæœ¬ -->
    <script>
        // æ€§èƒ½ç›‘æ§
        class PerformanceMonitor {
            constructor() {
                this.metrics = {};
                this.startTime = performance.now();
            }

            startMeasure(name) {
                this.metrics[name] = {
                    startTime: performance.now()
                };
            }

            endMeasure(name) {
                if (this.metrics[name]) {
                    this.metrics[name].endTime = performance.now();
                    this.metrics[name].duration = this.metrics[name].endTime - this.metrics[name].startTime;
                    console.log(`${name} took ${this.metrics[name].duration.toFixed(2)}ms`);
                    return this.metrics[name].duration;
                }
                return 0;
            }

            getPageLoadMetrics() {
                const navigation = performance.getEntriesByType('navigation')[0];
                return {
                    domContentLoaded: navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart,
                    loadComplete: navigation.loadEventEnd - navigation.loadEventStart,
                    firstPaint: this.getFirstPaint(),
                    firstContentfulPaint: this.getFirstContentfulPaint()
                };
            }

            getFirstPaint() {
                const paintEntries = performance.getEntriesByType('paint');
                const fpEntry = paintEntries.find(entry => entry.name === 'first-paint');
                return fpEntry ? fpEntry.startTime : 0;
            }

            getFirstContentfulPaint() {
                const paintEntries = performance.getEntriesByType('paint');
                const fcpEntry = paintEntries.find(entry => entry.name === 'first-contentful-paint');
                return fcpEntry ? fcpEntry.startTime : 0;
            }

            reportMetrics() {
                const metrics = this.getPageLoadMetrics();
                console.log('Page Load Metrics:', metrics);
                return metrics;
            }
        }

        // åˆ›å»ºå…¨å±€æ€§èƒ½ç›‘æ§å®ä¾‹
        const performanceMonitor = new PerformanceMonitor();

        // ç”¨æˆ·è¡Œä¸ºè¿½è¸ª
        function trackUserAction(action, properties = {}) {
            console.log('User Action:', {
                action: action,
                properties: properties,
                timestamp: new Date().toISOString()
            });

            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šå‘é€åˆ° Vercel Analytics
            // track(action, properties);
        }

        // é”™è¯¯è¿½è¸ª
        function trackError(errorType, errorMessage, context = {}) {
            console.log('Error Tracked:', {
                error_type: errorType,
                error_message: errorMessage,
                context: context,
                timestamp: new Date().toISOString()
            });
        }

        // é¡µé¢åŠ è½½å®ŒæˆåæŠ¥å‘Šæ€§èƒ½æŒ‡æ ‡
        window.addEventListener('load', () => {
            setTimeout(() => {
                performanceMonitor.reportMetrics();
                trackUserAction('page_load_complete', {
                    page: 'database_demo',
                    load_time: performance.now() - performanceMonitor.startTime
                });
            }, 1000);
        });
    </script>

    <script>
        // API è°ƒç”¨å‡½æ•°
        async function callAPI(action, data = null) {
            performanceMonitor.startMeasure(`api_${action}`);
            trackUserAction('api_call_start', { action: action, data: data });

            try {
                const response = await fetch('/api/db-working', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action, data })
                });

                // å…ˆè·å–åŸå§‹æ–‡æœ¬ç”¨äºè°ƒè¯•
                const text = await response.text();
                console.log('API å“åº”:', text);

                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    console.error('JSON è§£æé”™è¯¯:', e);
                    return {
                        success: false,
                        error: 'æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯: ' + text.substring(0, 100)
                    };
                }

                const duration = performanceMonitor.endMeasure(`api_${action}`);
                trackUserAction('api_call_success', {
                    action: action,
                    duration: duration,
                    response_time: duration
                });

                return result;
            } catch (error) {
                const duration = performanceMonitor.endMeasure(`api_${action}`);
                trackError('api_call_error', error.message, {
                    action: action,
                    duration: duration,
                    data: data
                });

                console.error('API è°ƒç”¨é”™è¯¯:', error);
                return { success: false, error: 'ç½‘ç»œé”™è¯¯: ' + error.message };
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        // åˆå§‹åŒ–æ•°æ®åº“
        async function initDatabase() {
            trackUserAction('database_init_start');
            showMessage('init-result', 'æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“...', 'info');

            const result = await callAPI('init');

            if (result.success) {
                trackUserAction('database_init_success');
                showMessage('init-result', 'âœ… ' + result.message, 'success');
            } else {
                trackError('database_init_error', result.error);
                showMessage('init-result', 'âŒ ' + result.error, 'error');
            }
        }

        // æ·»åŠ ç”¨æˆ·
        document.getElementById('user-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const age = document.getElementById('age').value;
            const city = document.getElementById('city').value;

            showMessage('add-result', 'æ­£åœ¨æ·»åŠ ç”¨æˆ·...', 'info');

            const result = await callAPI('insert', {
                name,
                email,
                age: age ? parseInt(age) : null,
                city: city || null
            });

            if (result.success) {
                showMessage('add-result', 'âœ… ' + result.message, 'success');
                document.getElementById('user-form').reset();
                loadAllUsers(); // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
            } else {
                showMessage('add-result', 'âŒ ' + result.error, 'error');
            }
        });

        // åŠ è½½æ‰€æœ‰ç”¨æˆ·
        async function loadAllUsers() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½ç”¨æˆ·åˆ—è¡¨...</div>';

            const result = await callAPI('select');

            if (result.success) {
                displayUsers(result.users);
            } else {
                usersList.innerHTML = `<div class="alert alert-error">âŒ ${result.error}</div>`;
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
        function displayUsers(users) {
            const usersList = document.getElementById('users-list');

            if (users.length === 0) {
                usersList.innerHTML = '<div class="alert alert-info">ğŸ“ æš‚æ— ç”¨æˆ·æ•°æ®</div>';
                return;
            }

            let tableHTML = `
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>å§“å</th>
                            <th>é‚®ç®±</th>
                            <th>å¹´é¾„</th>
                            <th>åŸå¸‚</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            users.forEach(user => {
                tableHTML += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.age || '-'}</td>
                        <td>${user.city || '-'}</td>
                        <td>${new Date(user.created_at).toLocaleString('zh-CN')}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="editUser(${user.id})">ç¼–è¾‘</button>
                            <button class="btn btn-danger" onclick="deleteUser(${user.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            usersList.innerHTML = tableHTML;
        }

        // æœç´¢ç”¨æˆ·
        async function searchUsers() {
            const searchTerm = document.getElementById('search-input').value;

            if (!searchTerm.trim()) {
                showMessage('search-result', 'è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'info');
                return;
            }

            showMessage('search-result', 'æ­£åœ¨æœç´¢...', 'info');

            const result = await callAPI('search', { search: searchTerm });

            if (result.success) {
                if (result.users.length === 0) {
                    showMessage('search-result', 'ğŸ” æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·', 'info');
                } else {
                    showMessage('search-result', `ğŸ” æ‰¾åˆ° ${result.users.length} ä¸ªåŒ¹é…çš„ç”¨æˆ·`, 'success');
                    displayUsers(result.users);
                }
            } else {
                showMessage('search-result', 'âŒ ' + result.error, 'error');
            }
        }

        // ç¼–è¾‘ç”¨æˆ·ï¼ˆç®€åŒ–ç‰ˆï¼‰
        async function editUser(userId) {
            const newName = prompt('è¯·è¾“å…¥æ–°çš„å§“å:');
            if (newName === null) return;

            const newEmail = prompt('è¯·è¾“å…¥æ–°çš„é‚®ç®±:');
            if (newEmail === null) return;

            const result = await callAPI('update', {
                id: userId,
                name: newName,
                email: newEmail
            });

            if (result.success) {
                alert('âœ… ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ');
                loadAllUsers();
            } else {
                alert('âŒ ' + result.error);
            }
        }

        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(userId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿ')) return;

            const result = await callAPI('delete', { id: userId });

            if (result.success) {
                alert('âœ… ç”¨æˆ·åˆ é™¤æˆåŠŸ');
                loadAllUsers();
            } else {
                alert('âŒ ' + result.error);
            }
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            const statsContent = document.getElementById('stats-content');
            statsContent.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...</div>';

            const result = await callAPI('stats');

            if (result.success) {
                displayStats(result.stats);
            } else {
                statsContent.innerHTML = `<div class="alert alert-error">âŒ ${result.error}</div>`;
            }
        }

        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        function displayStats(stats) {
            const statsContent = document.getElementById('stats-content');

            let statsHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${stats.total_users}</div>
                        <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.users_with_age || 0}</div>
                        <div class="stat-label">æœ‰å¹´é¾„ä¿¡æ¯</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.avg_age || '-'}</div>
                        <div class="stat-label">å¹³å‡å¹´é¾„</div>
                    </div>
                </div>
            `;

            if (stats.top_cities && stats.top_cities.length > 0) {
                statsHTML += `
                    <div style="margin-top: 2rem;">
                        <h3>ğŸ™ï¸ çƒ­é—¨åŸå¸‚</h3>
                        <ul style="list-style: none; padding: 0;">
                `;

                stats.top_cities.forEach(city => {
                    statsHTML += `
                        <li style="padding: 0.5rem; background: white; margin: 0.5rem 0; border-radius: 8px; display: flex; justify-content: space-between;">
                            <span>${city.city}</span>
                            <span style="color: #4f46e5; font-weight: bold;">${city.count} äºº</span>
                        </li>
                    `;
                });

                statsHTML += '</ul></div>';
            }

            statsContent.innerHTML = statsHTML;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        window.addEventListener('load', function () {
            loadStats();
        });

        // æœç´¢æ¡†å›è½¦äº‹ä»¶
        document.getElementById('search-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                searchUsers();
            }
        });
    </script>
</body>

</html>